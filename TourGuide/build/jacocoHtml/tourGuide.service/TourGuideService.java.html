<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TourGuideService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TourGuide</a> &gt; <a href="index.source.html" class="el_package">tourGuide.service</a> &gt; <span class="el_source">TourGuideService.java</span></div><h1>TourGuideService.java</h1><pre class="source lang-java linenums">package tourGuide.service;


import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.util.*;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;


import tourGuide.helper.InternalTestHelper;
import tourGuide.model.*;
import tourGuide.proxy.GpsUtilProxy;
import tourGuide.proxy.RewardCentralProxy;
import tourGuide.proxy.TripPricerProxy;
import tourGuide.tracker.Tracker;


@Service
public class TourGuideService {

    /**********************************************************************************
     *
     * Methods Below: For Internal Testing
     *
     **********************************************************************************/
<span class="fc" id="L35">    ExecutorService executorService = Executors.newFixedThreadPool(100);</span>

    private static final String            tripPricerApiKey = &quot;test-server-api-key&quot;;
    public final  Tracker        tracker;
    private final RewardsService rewardsService;
    @Autowired
    GpsUtilProxy gpsUtilProxy;
    @Autowired
    RewardCentralProxy rewardCentralProxy;
    @Autowired
    TripPricerProxy tripPricerProxy;
    // Database connection will be used for external users, but for testing purposes internal users are provided and stored in memory
<span class="fc" id="L47">    private final        Map&lt;String, User&gt; internalUserMap  = new HashMap&lt;&gt;();</span>
<span class="fc" id="L48">    boolean testMode = true;</span>
<span class="fc" id="L49">    private       Logger         logger     = LoggerFactory.getLogger(TourGuideService.class);</span>

<span class="fc" id="L51">    public TourGuideService(GpsUtilProxy gpsUtilProxy, RewardsService rewardsService) {</span>

<span class="fc" id="L53">        this.gpsUtilProxy        = gpsUtilProxy;</span>
<span class="fc" id="L54">        this.rewardsService = rewardsService;</span>

<span class="pc bpc" id="L56" title="1 of 2 branches missed.">        if (testMode) {</span>
<span class="fc" id="L57">            logger.info(&quot;TestMode activÃ©&quot;);</span>
<span class="fc" id="L58">            logger.debug(&quot;initialiser les utilisateurs&quot;);</span>
<span class="fc" id="L59">            initializeInternalUsers();</span>
<span class="fc" id="L60">            logger.debug(&quot;utilisateurs initialisÃ©&quot;);</span>
        }
<span class="fc" id="L62">        tracker = new Tracker(this);</span>
<span class="fc" id="L63">        addShutDownHook();</span>
<span class="fc" id="L64">    }</span>

    public List&lt;UserReward&gt; getUserRewards(User user) {

<span class="nc" id="L68">        return user.getUserRewards();</span>
    }

    public VisitedLocation getUserLocation(User user) {

<span class="nc bnc" id="L73" title="All 2 branches missed.">        return (user.getVisitedLocations().size() &gt; 0) ?</span>
<span class="nc" id="L74">                user.getLastVisitedLocation() :</span>
<span class="nc" id="L75">                trackUserLocation(user);</span>
    }
    public User getUser(String userName) {

<span class="fc" id="L79">        return internalUserMap.get(userName);</span>
    }

    public List&lt;User&gt; getAllUsers() {

<span class="fc" id="L84">        return internalUserMap.values().stream().collect(Collectors.toList());</span>
    }

    public void trackUserLocationWithThread(User user) {
<span class="fc" id="L88">        executorService.execute(new Runnable() {</span>
            public void run() {
<span class="nc" id="L90">                trackUserLocation(user);</span>
<span class="nc" id="L91">            }</span>
        });
<span class="fc" id="L93">    }</span>

    public void shutdown() throws InterruptedException {
<span class="fc" id="L96">        executorService.shutdown();</span>
<span class="fc" id="L97">        executorService.awaitTermination(Long.MAX_VALUE, TimeUnit.NANOSECONDS);</span>

<span class="fc" id="L99">    }</span>


    public void addUser(User user) {

<span class="pc bpc" id="L104" title="1 of 2 branches missed.">        if (!internalUserMap.containsKey(user.getUserName())) {</span>
<span class="fc" id="L105">            internalUserMap.put(user.getUserName(), user);</span>
        }
<span class="fc" id="L107">    }</span>

    public List&lt;Provider&gt; getTripDeals(User user, int tripDuration, int numberOfAdults, int numberOfChildren) {
<span class="fc" id="L110">        int rewardCumul = user.getUserRewards().stream().mapToInt(UserReward::getRewardPoints).sum();</span>
<span class="fc" id="L111">        UserPreferences preferences = new UserPreferences();</span>
<span class="fc" id="L112">        preferences.setTripDuration(tripDuration);</span>
<span class="fc" id="L113">        preferences.setNumberOfAdults(numberOfAdults);</span>
<span class="fc" id="L114">        preferences.setNumberOfChildren(numberOfChildren);</span>
<span class="fc" id="L115">        user.setUserPreferences(preferences);</span>
<span class="fc" id="L116">        List&lt;Provider&gt; providers = tripPricerProxy.getPrice(tripPricerApiKey, user.getUserId(), user.getUserPreferences().getNumberOfAdults(),</span>
<span class="fc" id="L117">                user.getUserPreferences().getNumberOfChildren(), user.getUserPreferences().getTripDuration(), rewardCumul);</span>
<span class="fc" id="L118">        user.setTripDeals(providers);</span>
<span class="fc" id="L119">        return providers;</span>
    }

    public VisitedLocation trackUserLocation(User user) {

<span class="nc" id="L124">        VisitedLocation visitedLocation = gpsUtilProxy.getUserLocation(user.getUserId());</span>
<span class="nc" id="L125">        user.addToVisitedLocations(visitedLocation);</span>
<span class="nc" id="L126">        rewardsService.calculateRewards(user);</span>
<span class="nc" id="L127">        return visitedLocation;</span>
    }

    public List&lt;Attraction&gt; getNearByAttractions(VisitedLocation visitedLocation) {

<span class="nc" id="L132">        List&lt;Attraction&gt; nearbyAttractions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        for (Attraction attraction : gpsUtilProxy.getAttractions()) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (rewardsService.isWithinAttractionProximity(attraction, visitedLocation.getLocation())) {</span>
<span class="nc" id="L135">                nearbyAttractions.add(attraction);</span>
            }
<span class="nc" id="L137">        }</span>

<span class="nc" id="L139">        return nearbyAttractions;</span>
    }

    private void addShutDownHook() {

<span class="fc" id="L144">        Runtime.getRuntime().addShutdownHook(new Thread() {</span>

            public void run() {

<span class="fc" id="L148">                tracker.stopTracking();</span>
<span class="fc" id="L149">            }</span>
        });
<span class="fc" id="L151">    }</span>

    private void initializeInternalUsers() {

<span class="fc" id="L155">        IntStream.range(0, InternalTestHelper.getInternalUserNumber()).forEach(i -&gt; {</span>
<span class="fc" id="L156">            String userName = &quot;internalUser&quot; + i;</span>
<span class="fc" id="L157">            String phone    = &quot;000&quot;;</span>
<span class="fc" id="L158">            String email    = userName + &quot;@tourGuide.com&quot;;</span>
<span class="fc" id="L159">            User   user     = new User(UUID.randomUUID(), userName, phone, email);</span>
<span class="fc" id="L160">            generateUserLocationHistory(user);</span>

<span class="fc" id="L162">            internalUserMap.put(userName, user);</span>
<span class="fc" id="L163">        });</span>
<span class="fc" id="L164">        logger.debug(&quot;Created &quot; + InternalTestHelper.getInternalUserNumber() + &quot; internal test users.&quot;);</span>
<span class="fc" id="L165">    }</span>

    private void generateUserLocationHistory(User user) {

<span class="fc" id="L169">        IntStream.range(0, 3).forEach(i -&gt; {</span>
<span class="fc" id="L170">            user.addToVisitedLocations(new VisitedLocation(user.getUserId(), new Location(generateRandomLatitude(), generateRandomLongitude()), getRandomTime()));</span>
<span class="fc" id="L171">        });</span>
<span class="fc" id="L172">    }</span>

    private double generateRandomLongitude() {

<span class="fc" id="L176">        double leftLimit  = -180;</span>
<span class="fc" id="L177">        double rightLimit = 180;</span>
<span class="fc" id="L178">        return leftLimit + new Random().nextDouble() * (rightLimit - leftLimit);</span>
    }

    private double generateRandomLatitude() {

<span class="fc" id="L183">        double leftLimit  = -85.05112878;</span>
<span class="fc" id="L184">        double rightLimit = 85.05112878;</span>
<span class="fc" id="L185">        return leftLimit + new Random().nextDouble() * (rightLimit - leftLimit);</span>
    }

    private Date getRandomTime() {

<span class="fc" id="L190">        LocalDateTime localDateTime = LocalDateTime.now().minusDays(new Random().nextInt(30));</span>
<span class="fc" id="L191">        return Date.from(localDateTime.toInstant(ZoneOffset.UTC));</span>
    }

    public List&lt;AllUsersCurrentLocations&gt; getAllCurrentLocations() {
<span class="fc" id="L195">        List&lt;User&gt; users = this.getAllUsers();</span>
<span class="fc" id="L196">        List&lt;AllUsersCurrentLocations&gt; currentLocations = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">        for (User user : users) {</span>
<span class="fc" id="L198">            this.generateUserLocationHistory(user);</span>
<span class="fc" id="L199">            VisitedLocation lastLocation = user.getLastVisitedLocation();</span>
<span class="fc" id="L200">            AllUsersCurrentLocations currentLocation = new AllUsersCurrentLocations(lastLocation.getUserId(), lastLocation.getLocation().getLatitude(), lastLocation.getLocation().getLongitude());</span>
<span class="fc" id="L201">            currentLocations.add(currentLocation);</span>
<span class="fc" id="L202">        }</span>
<span class="fc" id="L203">        return currentLocations;</span>

    }

    public List&lt;NearAttractions&gt; getNeardistance(VisitedLocation visitedLocation, User user) {
<span class="nc" id="L208">        List&lt;NearAttractions&gt; nearAttractions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        for (Attraction attraction : gpsUtilProxy.getAttractions()) {</span>
<span class="nc" id="L210">            double distance = rewardsService.getDistance(new Location(attraction.getLatitude(), attraction.getLongitude()), new Location(visitedLocation.getLocation().getLatitude(), visitedLocation.getLocation().getLongitude()));</span>
<span class="nc" id="L211">            NearAttractions nearAttraction = new NearAttractions(attraction.getAttractionName(), distance, attraction.getLatitude(), attraction.getLongitude(), visitedLocation.getLocation(), rewardCentralProxy.getAttractionRewardPoints(attraction.getAttractionId(), user.getUserId()));</span>
<span class="nc" id="L212">            nearAttractions.add(nearAttraction);</span>
<span class="nc" id="L213">            nearAttractions.sort(Comparator.comparingDouble(NearAttractions::getDistance));</span>
<span class="nc" id="L214">        }</span>
<span class="nc" id="L215">        return nearAttractions;</span>
    }

    public List&lt;NearAttractions&gt; getNearFiveAttractions(VisitedLocation visitedLocation, User user) {
<span class="nc" id="L219">        List&lt;NearAttractions&gt; nearAttractions = this.getNeardistance(visitedLocation, user);</span>
<span class="nc" id="L220">        List&lt;NearAttractions&gt; fiveNearAttractions = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">        for (NearAttractions nearAttraction : nearAttractions) {</span>

<span class="nc bnc" id="L224" title="All 2 branches missed.">            while (fiveNearAttractions.size() &lt; 5) {</span>
<span class="nc" id="L225">                fiveNearAttractions.add(nearAttraction);</span>
            }
<span class="nc" id="L227">        }</span>
<span class="nc" id="L228">        return fiveNearAttractions;</span>

    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>